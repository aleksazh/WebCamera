<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<body>
  <div id="container">
    <canvas class="center-block" id="canvasOutput" width=320 height=240></canvas>
  </div>
  <link href="style.css" rel="stylesheet" type="text/css" />
  <div class="invisible">
    <video id="video" class="hidden">Your browser does not support the video tag.</video>
  </div>
</body>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="https://rawgit.com/mrdoob/stats.js/master/build/stats.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.5/dat.gui.min.js"></script>
<script>
  let Module = {
    preRun: [function () {
      Module.FS_createPreloadedFile('/', 'haarcascade_eye.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_eye.xml', true, false);
      Module.FS_createPreloadedFile('/', 'haarcascade_frontalface_default.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml', true, false);
      Module.FS_createPreloadedFile('/', 'haarcascade_profileface.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_profileface.xml', true, false);
    }],
    _main: function () { opencvIsReady(); }
  };
</script>
<script async src="https://huningxin.github.io/opencv.js/build/asm.js/opencv.js"></script>
<script type="text/js-worker">
 let Module = {
    preRun: [function() {
      Module.FS_createPreloadedFile('/', 'haarcascade_eye.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_eye.xml', true, false);
      Module.FS_createPreloadedFile('/', 'haarcascade_frontalface_default.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml', true, false);
      Module.FS_createPreloadedFile('/', 'haarcascade_profileface.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_profileface.xml', true, false);
    }],
    _main: function() {opencvIsReady();}
  };

  self.importScripts('https://huningxin.github.io/opencv.js/build/asm.js/opencv.js');

  function opencvIsReady() {
    console.log('OpenCV.js is ready for worker');
    workerInit();
  }

  let classifier;
  function workerInit() {
    classifier = new cv.CascadeClassifier();
    let status = classifier.load('haarcascade_frontalface_default.xml');
    console.log('worker init status ' + status);
    self.postMessage({response: 'init_ok'});
  }

  var buffer;
  let width;
  let height;

  self.addEventListener('message', (msg) => {
    switch (msg.data.cmd) {
      case 'detect': {
        //let mat = cv.matFromImageData(buffer);
        let mat = new cv.Mat(height, width, cv.CV_8UC4);
        mat.data.set(new Uint8Array(buffer));
        cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY);
        let results = new cv.RectVector();
        let objects = [];
        classifier.detectMultiScale(mat, results, 1.1, 3, 0, {width : 0, height : 0}, {width : 0, height : 0});
        //console.log('worker detect ' + results.size());
        for (let i = 0; i < results.size(); i++) {
          objects.push(results.get(i));
        }
        self.postMessage({response: 'detect', objects: objects});
        mat.delete();
        results.delete();
      }
      case 'init': {
        buffer = msg.data.buffer;
        width = msg.data.width;
        height = msg.data.height;
        //let mat = cv.matFromImageData(buffer);
        let mat = new cv.Mat(height, width, cv.CV_8UC4);
        mat.data.set(new Uint8Array(buffer));
        cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY);
        let results = new cv.RectVector();
        let objects = [];
        classifier.detectMultiScale(mat, results, 1.1, 3, 0, {width : 0, height : 0}, {width : 0, height : 0});
        //console.log('worker detect ' + results.size());
        for (let i = 0; i < results.size(); i++) {
          objects.push(results.get(i));
        }
        self.postMessage({response: 'detect', objects: objects});
        mat.delete();
        results.delete();
        break;
      }
      default: {
        throw('invalid command from main thread');
      }
    }
  }, false);

</script>
<script src="index.js" type="text/javascript"></script>